<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Çamakoğlu Sülalesi</title>
<link rel="stylesheet" href="css/familienbaum.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
<style>
    /* Modern Modal Styles */
    #crop-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    #crop-modal-content {
        background-color: white;
        margin: auto;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        width: 90%;
        max-width: 700px;
        max-height: 90%;
        display: flex;
        flex-direction: column;
    }
    #crop-image-container {
        max-height: 60vh;
        overflow: hidden;
        margin-bottom: 24px;
        border-radius: 8px;
        background: #f8f9fa;
    }
    #crop-image-container img {
        max-width: 100%;
        border-radius: 8px;
    }
    .crop-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    .crop-actions button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    #btn-cancel-crop {
        background: #e2e8f0;
        color: #2d3748;
    }
    #btn-cancel-crop:hover {
        background: #cbd5e0;
    }
    #btn-confirm-crop {
        background: #52a788;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #btn-confirm-crop:hover {
        background: #45916f;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
</head>
<body>
    <!-- Tree Container (SVG goes here) -->
    <div id="tree-container" style="width:100%; height:100vh;"></div>

    <!-- STATIC SIDEBAR STRUCTURE -->
    <aside id="family-sidebar">
        <div class="sidebar-header">
            <h2 id="sidebar-title">Kişi Adı</h2>
            <button class="close-btn" onclick="closeSidebar()">✕</button>
        </div>
        
        <div class="sidebar-content">
            <!-- Profile Image -->
            <div class="sidebar-section photo-section" style="text-align: center;">
                <div style="position: relative; display: inline-block;">
                    <img id="sidebar-image" src="" alt="Fotoğraf" style="max-width: 100%; max-height: 220px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; cursor: pointer; transition: all 0.3s ease;">
                    <button id="delete-photo-btn" style="display: none; position: absolute; top: 8px; right: 8px; background: #c84b4b; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; font-weight: bold; line-height: 1; padding: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s ease;">×</button>
                </div>
                <div id="upload-status" style="font-size: 0.95rem; color: #718096; margin-top: 12px; min-height: 1.2em; font-weight: 500;"></div>
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
            </div>
            
            <!-- Dynamic Details -->
            <div class="sidebar-section">
                <div id="sidebar-details"></div>
            </div>

            <!-- Action Buttons -->
            <div class="sidebar-section">
                <button id="btn-parents" class="action-btn btn-primary">Ataları Göster (Anne/Baba)</button>
                <button id="btn-children" class="action-btn btn-primary">Torunları Göster (Çocuklar)</button>
            </div>
            
            <!-- Meta -->
            <div class="sidebar-section">
                <button id="btn-open-sheet" class="action-btn btn-secondary" onclick="openSheet()">Google Tablosunu Aç</button>
            </div>
        </div>
    </aside>

    <!-- CROP MODAL -->
    <div id="crop-modal">
        <div id="crop-modal-content">
            <h3>Fotoğrafı Kırp</h3>
            <div id="crop-image-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="crop-actions">
                <button id="btn-cancel-crop" class="action-btn btn-secondary">İptal</button>
                <button id="btn-confirm-crop" class="action-btn btn-success">✂️ Kırp ve Yükle</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
	<script src="js/d3.v7.min.js"></script>
	<script src="js/dag.js"></script>
	<script src="js/dag_layout.js"></script>
	<script src="js/dag_with_relations.js"></script>
	<script src="js/dag_with_family_data.js"></script>
	<script src="js/dag_relaxation.js"></script>
	<script src="js/familienbaum.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/sheet_loader.js"></script>
    
    <!-- Minimal Logic for Sidebar Interaction -->
    <script>
        // Global UI Functions
        function closeSidebar() {
            document.getElementById('family-sidebar').classList.remove('active');
        }
        
        function openDriveFolder() {
            window.open("https://drive.google.com/drive/folders/1DzFjTHjzsnM1dcJMF4jZU5RDliCzX0xH?usp=drive_link", "_blank");
        }
        
        function openSheet() {
            window.open("https://docs.google.com/spreadsheets/d/12kZlANYbq0w3k8TpDxssVSlWVfbs-qZQ9bAjERci0SM/edit?gid=790197592", "_blank");
        }

        // Initialize D3 in specific container
		const svg = d3.select("#tree-container").append("svg").
			attr("width", document.body.offsetWidth).
			attr("height", document.documentElement.clientHeight);
            
        // Restore Resize Listener
        window.addEventListener("resize", () => {
            svg.attr("width", document.body.offsetWidth)
               .attr("height", document.documentElement.clientHeight);
        });
            
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzo66Bb8-z3QdqtNGZ9uhQJZJxePifl6nJwvtlot-3JtKp4YKYQdqJNFDY89lqHoMRdlKZmjWzh2OA/pub?output=csv";

        async function initApp() {
            let inputData = null;
            try {
                inputData = await loadFromGoogleSheet(SHEET_URL);
                localStorage.setItem('soyagaci_cached_data', JSON.stringify(inputData));
            } catch (e) {
                console.warn("Network failed, trying cache...", e);
                const cached = localStorage.getItem('soyagaci_cached_data');
                if (cached) inputData = JSON.parse(cached);
            }

            if (!inputData) {
                alert("Could not load data.");
                return;
            }

            // Restore state
            const lastNodeId = localStorage.getItem('soyagaci_last_node');
            if (lastNodeId && inputData.members[lastNodeId]) {
                inputData.start = lastNodeId;
            }

            // Expose data globally for editor
            window.familyData = inputData;

            // We no longer pass 'detailsDiv' to constructor because we manage it globally now
            let familienbaum = new Familienbaum(inputData, svg);
            familienbaum.draw();
        }

        // Shift Key Listeners
        document.addEventListener('keydown', (e) => { if (e.key === 'Shift') document.body.classList.add('show-plus'); });
        document.addEventListener('keyup', (e) => { if (e.key === 'Shift') document.body.classList.remove('show-plus'); });

        initApp();
    </script>
</body>
</html>